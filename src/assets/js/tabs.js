/* =====================================
   TABS.JS - SIMPLE TAB NAVIGATION
   Sistema de navega√ß√£o sequencial de 8 m√≥dulos:
   1. Cadastro e Identifica√ß√£o
   2. Demonstra√ß√µes Financeiras
   3. An√°lise de Endividamento
   4. Compliance e Verifica√ß√µes
   5. Recursos Humanos
   6. √çndices Financeiros (Computado)
   7. Scoring de Cr√©dito (Computado)
   8. Relat√≥rios e An√°lises (Computado)

   Abordagem h√≠brida: HTML hardcoded + JavaScript para m√≥dulos computados
   ===================================== */

class SimpleTabNavigation {
    constructor() {
        // Tab state
        this.currentTab = 1;
        this.totalTabs = 8;

        // Guards contra loops e re-entrada
        this._switching = false; // Guard para switchTab()
        this._updateTimeout = null; // Timeout para debounce de updateAllStates()

        // Module names (matches data-module attributes)
        this.modules = [
            'cadastro',
            'demonstracoes',
            'endividamento',
            'compliance',
            'recursos-humanos',
            'indices',
            'scoring',
            'relatorios'
        ];

        // Tab states
        this.completedTabs = new Set();
        this.tabsWithErrors = new Set();
        this.tabsWithWarnings = new Set();

        console.log(`[SimpleTabNavigation] Inicializado com ${this.totalTabs} tabs sequenciais`);
    }

    /**
     * Gera estrutura HTML completa de tabs
     * Cria: .tab-list com 8 .tab-item (um para cada m√≥dulo)
     */
    generateTabsHTML() {
        const navContainer = document.getElementById('tabNavigation');
        if (!navContainer) {
            throw new Error('SimpleTabNavigation: #tabNavigation n√£o encontrado');
        }

        // Criar tab-list
        const tabList = document.createElement('div');
        tabList.className = 'tab-list';
        tabList.setAttribute('role', 'tablist');

        // Criar tab-item para cada m√≥dulo
        this.modules.forEach((moduleName, index) => {
            const tabNumber = index + 1;
            
            // Mapear √≠cones e labels dos m√≥dulos
            const moduleInfo = {
                'cadastro': { icon: 'üè¢', label: 'Cadastro' },
                'demonstracoes': { icon: 'üìä', label: 'Demonstra√ß√µes' },
                'endividamento': { icon: 'üí≥', label: 'Endividamento' },
                'compliance': { icon: '‚úÖ', label: 'Compliance' },
                'recursos-humanos': { icon: 'üë•', label: 'Recursos Humanos' },
                'indices': { icon: 'üìà', label: '√çndices' },
                'scoring': { icon: '‚≠ê', label: 'Scoring' },
                'relatorios': { icon: 'üìÑ', label: 'Relat√≥rios' }
            };

            const info = moduleInfo[moduleName] || { icon: 'üìÑ', label: moduleName };

            const tabItem = document.createElement('button');
            tabItem.className = 'tab-item';
            tabItem.setAttribute('role', 'tab');
            tabItem.setAttribute('data-tab', tabNumber);
            tabItem.setAttribute('aria-label', `M√≥dulo ${tabNumber}: ${info.label}`);
            
            tabItem.innerHTML = `
                <span class="tab-number">${tabNumber}</span>
                <span class="tab-label">${info.icon} ${info.label}</span>
                <span class="tab-status"></span>
            `;

            // Click handler
            tabItem.addEventListener('click', () => this.switchTab(tabNumber));

            tabList.appendChild(tabItem);
        });

        // Limpar e adicionar ao container
        navContainer.innerHTML = '';
        navContainer.appendChild(tabList);

        console.log(`[SimpleTabNavigation] ${this.totalTabs} tabs geradas no HTML`);
    }

    /**
     * Inicializa√ß√£o ap√≥s DOM estar pronto
     * DEVE ser chamado pelo main app ap√≥s generateInterface()
     */
    async init() {
        this.generateTabsHTML();
        this.setupEventListeners();
        this.loadTabState();
        this.updateAllStates();
        this.showTab(this.currentTab);
        console.log(`[SimpleTabNavigation] init() completo - tab ${this.currentTab} ativa`);
    }

    setupEventListeners() {
        // Navega√ß√£o entre tabs
        const prevBtn = document.getElementById('prevTab');
        const nextBtn = document.getElementById('nextTab');

        if (prevBtn) {
            prevBtn.addEventListener('click', () => this.previousTab());
        }

        if (nextBtn) {
            nextBtn.addEventListener('click', () => this.nextTab());
        }

        // Form field change events for auto-save
        const form = document.getElementById('creditScoreForm');
        if (form) {
            form.addEventListener('input', () => {
                this.validateCurrentTabFields();
            });

            form.addEventListener('change', () => {
                this.validateCurrentTabFields();
                this.autoSaveData();
            });
        }

        // Keyboard shortcuts (Ctrl+Arrow)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    this.previousTab();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    this.nextTab();
                }
            }
        });
    }

    /**
     * Navegar para a pr√≥xima tab
     */
    nextTab() {
        if (this.currentTab < this.totalTabs) {
            this.switchTab(this.currentTab + 1);
        }
    }

    /**
     * Navegar para a tab anterior
     */
    previousTab() {
        if (this.currentTab > 1) {
            this.switchTab(this.currentTab - 1);
        }
    }

    /**
     * Trocar para uma tab espec√≠fica
     */
    switchTab(tabNumber) {
        // ‚úÖ Guard contra re-entrada (evita loop infinito)
        if (this._switching) {
            console.warn(`[SimpleTabNavigation] switchTab(${tabNumber}) bloqueado: j√° em execu√ß√£o`);
            return;
        }
        this._switching = true;

        if (tabNumber < 1 || tabNumber > this.totalTabs) {
            this._switching = false;
            return;
        }

        // Validar tab atual antes de sair (apenas marca se h√° erros, mas permite navega√ß√£o)
        if (this.currentTab !== tabNumber) {
            this.validateCurrentTabFields();
        }

        this.currentTab = tabNumber;

        // ‚úÖ C√ÅLCULO AUTOM√ÅTICO: Disparar ao navegar para abas de resultado
        this.handleCalculationTrigger(tabNumber);

        this.showTab(tabNumber);
        this.updateAllStates();
        this.saveTabState();

        // Auto-save apenas se IndexedDB estiver pronto
        if (this.isIndexedDBReady()) {
            this.autoSaveData();
        }

        // ‚úÖ Release guard
        this._switching = false;
    }

    /**
     * Alias para switchTab - compatibilidade com NavigationController
     * @param {number} tabNumber - N√∫mero da tab (1-8)
     */
    switchToTab(tabNumber) {
        return this.switchTab(tabNumber);
    }

    /**
     * Mostrar uma tab espec√≠fica (form section)
     */
    showTab(tabNumber) {
        // Ocultar todas as se√ß√µes
        const sections = document.querySelectorAll('.form-section');
        sections.forEach(section => {
            section.classList.remove('active');
            section.style.display = 'none';
        });

        // Mostrar a se√ß√£o target
        const moduleName = this.modules[tabNumber - 1];
        const targetSection = document.querySelector(`[data-module="${moduleName}"]`);

        if (targetSection) {
            targetSection.classList.add('active');
            targetSection.style.display = 'block';
            targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            console.error(`[SimpleTabNavigation] Se√ß√£o n√£o encontrada: data-module="${moduleName}"`);
        }

        // Atualizar bot√µes de navega√ß√£o
        this.updateNavigationButtons();

        // Atualizar barra de progresso
        this.updateProgressBar();

        console.log(`[SimpleTabNavigation] Tab ${tabNumber} (${moduleName}) ativa`);
    }

    /**
     * Atualizar estados dos bot√µes de navega√ß√£o
     */
    updateNavigationButtons() {
        const prevBtn = document.getElementById('prevTab');
        const nextBtn = document.getElementById('nextTab');

        if (prevBtn) {
            prevBtn.disabled = this.currentTab === 1;
        }

        if (nextBtn) {
            nextBtn.disabled = this.currentTab === this.totalTabs;
            nextBtn.textContent = this.currentTab === this.totalTabs ? 'Finalizar' : 'Pr√≥ximo';
        }
    }

    /**
     * Atualizar barra de progresso
     */
    updateProgressBar() {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        if (progressBar) {
            const percentage = (this.currentTab / this.totalTabs) * 100;
            progressBar.style.width = `${percentage}%`;
        }

        if (progressText) {
            progressText.textContent = `${this.currentTab}/${this.totalTabs} - ${this.modules[this.currentTab - 1]}`;
        }
    }

    /**
     * Validar campos da tab atual (marcadores visuais apenas)
     */
    validateCurrentTabFields() {
        const moduleName = this.modules[this.currentTab - 1];
        const currentSection = document.querySelector(`[data-module="${moduleName}"]`);

        if (!currentSection) return;

        const requiredFields = currentSection.querySelectorAll('[required]');
        let hasErrors = false;
        let hasWarnings = false;

        requiredFields.forEach(field => {
            const isValid = field.value.trim() !== '';
            field.classList.toggle('error', !isValid);
            if (!isValid) hasErrors = true;
        });

        // Atualizar estado da tab
        if (hasErrors) {
            this.tabsWithErrors.add(this.currentTab);
            this.completedTabs.delete(this.currentTab);
            this.tabsWithWarnings.delete(this.currentTab);
        } else if (hasWarnings) {
            this.tabsWithWarnings.add(this.currentTab);
            this.tabsWithErrors.delete(this.currentTab);
        } else {
            this.completedTabs.add(this.currentTab);
            this.tabsWithErrors.delete(this.currentTab);
            this.tabsWithWarnings.delete(this.currentTab);
        }

        this.updateAllStates();
    }

    /**
     * Atualizar todos os estados (tabs, progresso)
     */
    updateAllStates() {
        // ‚úÖ Debounce para evitar chamadas em r√°pida sucess√£o
        if (this._updateTimeout) {
            clearTimeout(this._updateTimeout);
        }

        this._updateTimeout = setTimeout(() => {
            this.updateProgressBar();
            this.updateNavigationButtons();
            this.updateProgressText();

            // ‚úÖ Limpar TODAS as classes de estado antes de reaplicar (evita ac√∫mulo)
            const allTabs = document.querySelectorAll('.tab-item');
            allTabs.forEach(tab => {
                tab.classList.remove('active', 'completed', 'error', 'warning');
            });

            // Atualizar visual de todas as tabs
            for (let i = 1; i <= this.totalTabs; i++) {
                this.updateTabVisualState(i);
            }

            this._updateTimeout = null;
        }, 10); // 10ms debounce
    }

    /**
     * Atualizar texto de progresso
     */
    updateProgressText() {
        const progressText = document.getElementById('progressText');
        if (progressText) {
            const completed = this.completedTabs.size;
            progressText.textContent = `${this.currentTab}/${this.totalTabs} - ${completed} conclu√≠das`;
        }
    }

    /**
     * Atualiza estado visual de uma tab espec√≠fica
     * @param {number} tabNumber - N√∫mero da tab (1-8)
     */
    updateTabVisualState(tabNumber) {
        const tabItem = document.querySelector(`.tab-item[data-tab="${tabNumber}"]`);
        if (!tabItem) return;

        // Remover todas as classes de estado
        tabItem.classList.remove('active', 'completed', 'error', 'warning');

        // Aplicar nova classe baseada no estado
        if (this.currentTab === tabNumber) {
            tabItem.classList.add('active');
        } else if (this.tabsWithErrors.has(tabNumber)) {
            tabItem.classList.add('error');
        } else if (this.tabsWithWarnings.has(tabNumber)) {
            tabItem.classList.add('warning');
        } else if (this.completedTabs.has(tabNumber)) {
            tabItem.classList.add('completed');
        }
    }

    /**
     * Check if IndexedDB is ready
     */
    isIndexedDBReady() {
        if (window.creditScoreModule && typeof window.creditScoreModule.isReady === 'function') {
            return window.creditScoreModule.isReady();
        }
        return true;
    }

    /**
     * Auto-save data (delegates to external function)
     */
    autoSaveData() {
        if (typeof autoSaveData === 'function') {
            autoSaveData();
        } else if (window.creditScoreModule && typeof window.creditScoreModule.autoSave === 'function') {
            window.creditScoreModule.autoSave();
        }
    }

    /**
     * Save tab state to localStorage
     */
    saveTabState() {
        const state = {
            currentTab: this.currentTab,
            completedTabs: Array.from(this.completedTabs),
            tabsWithErrors: Array.from(this.tabsWithErrors),
            tabsWithWarnings: Array.from(this.tabsWithWarnings),
            timestamp: Date.now()
        };

        try {
            localStorage.setItem('creditscore_tab_state', JSON.stringify(state));
        } catch (e) {
            console.warn('Could not save tab state to localStorage:', e);
        }
    }

    /**
     * Load tab state from localStorage
     */
    loadTabState() {
        try {
            const saved = localStorage.getItem('creditscore_tab_state');
            if (!saved) return;

            const state = JSON.parse(saved);

            // ‚úÖ Validar estrutura do estado salvo
            if (!this.#validateTabState(state)) {
                console.warn('[SimpleTabNavigation] Estado corrompido detectado - limpando localStorage');
                localStorage.removeItem('creditscore_tab_state');
                return;
            }

            // ‚úÖ Restaurar apenas valores v√°lidos
            this.currentTab = state.currentTab;
            this.completedTabs = new Set(state.completedTabs);
            this.tabsWithErrors = new Set(state.tabsWithErrors);
            this.tabsWithWarnings = new Set(state.tabsWithWarnings);

            console.log(`[SimpleTabNavigation] Estado restaurado: tab ${this.currentTab}`);
        } catch (e) {
            console.warn('[SimpleTabNavigation] Erro ao carregar estado - limpando:', e);
            localStorage.removeItem('creditscore_tab_state');
        }
    }

    /**
     * Valida estrutura do estado salvo
     * @private
     */
    #validateTabState(state) {
        // Validar tipos b√°sicos
        if (!state || typeof state !== 'object') return false;

        // Validar currentTab
        const currentTab = parseInt(state.currentTab);
        if (isNaN(currentTab) || currentTab < 1 || currentTab > this.totalTabs) {
            return false;
        }

        // Validar arrays de tabs
        const tabArrays = [
            state.completedTabs,
            state.tabsWithErrors,
            state.tabsWithWarnings
        ];

        for (const arr of tabArrays) {
            if (!Array.isArray(arr)) return false;

            // Validar cada tab no array
            for (const tabNum of arr) {
                const num = parseInt(tabNum);
                if (isNaN(num) || num < 1 || num > this.totalTabs) {
                    return false;
                }
            }
        }

        return true;
    }

    // ============================================
    // PUBLIC API METHODS
    // ============================================

    getCurrentTab() {
        return this.currentTab;
    }

    getCompletedTabs() {
        return Array.from(this.completedTabs);
    }

    markTabAsCompleted(tabNumber) {
        this.completedTabs.add(tabNumber);
        this.tabsWithErrors.delete(tabNumber);
        this.tabsWithWarnings.delete(tabNumber);
        this.updateAllStates();
        this.saveTabState();
    }

    markTabAsError(tabNumber) {
        this.tabsWithErrors.add(tabNumber);
        this.completedTabs.delete(tabNumber);
        this.tabsWithWarnings.delete(tabNumber);
        this.updateAllStates();
        this.saveTabState();
    }

    markTabAsWarning(tabNumber) {
        this.tabsWithWarnings.add(tabNumber);
        this.tabsWithErrors.delete(tabNumber);
        this.updateAllStates();
        this.saveTabState();
    }

    validateAllTabs() {
        let allValid = true;

        for (let i = 1; i <= this.totalTabs; i++) {
            const originalTab = this.currentTab;
            this.currentTab = i;

            const moduleName = this.modules[i - 1];
            const currentSection = document.querySelector(`[data-module="${moduleName}"]`);

            if (!currentSection) continue;

            const requiredFields = currentSection.querySelectorAll('[required]');
            let hasErrors = false;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    hasErrors = true;
                }
            });

            if (hasErrors) {
                this.markTabAsError(i);
                allValid = false;
            } else {
                this.markTabAsCompleted(i);
            }

            this.currentTab = originalTab;
        }

        return allValid;
    }

    /**
     * Dispara c√°lculo autom√°tico ao navegar para abas de resultado
     * Integrado com CalculationOrchestrator e CalculationState
     * @param {number} tabNumber
     */
    async handleCalculationTrigger(tabNumber) {
        // Abas de resultado que requerem c√°lculo
        const resultTabs = [6, 7, 8]; // √çndices, Scoring, Relat√≥rios

        if (!resultTabs.includes(tabNumber)) {
            return; // N√£o √© aba de resultado, n√£o faz nada
        }

        // Verificar se orchestrator est√° dispon√≠vel
        if (!window.calculationOrchestrator) {
            console.warn('[TabNavigation] CalculationOrchestrator n√£o dispon√≠vel');
            return;
        }

        if (!window.calculationState) {
            console.warn('[TabNavigation] CalculationState n√£o dispon√≠vel');
            return;
        }

        const state = window.calculationState.getState();

        // Verificar se precisa recalcular
        const needsCalculation = state.dataChanged || !state.lastCalculated;

        if (!needsCalculation) {
            console.log(`[TabNavigation] C√°lculos j√° atualizados, n√£o √© necess√°rio recalcular`);
            return;
        }

        console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
        console.log(`üéØ [TabNavigation] Aba ${tabNumber} - Disparando c√°lculo autom√°tico`);
        console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);

        try {
            // Mostrar loading overlay
            this.showCalculatingOverlay();

            // Executar c√°lculos via orchestrator
            const results = await window.calculationOrchestrator.performAllCalculations();

            // Ocultar loading
            this.hideCalculatingOverlay();

            // Mostrar toast de sucesso
            this.showToast('C√°lculos atualizados com sucesso', 'success');

            console.log('‚úÖ [TabNavigation] C√°lculo autom√°tico conclu√≠do');

        } catch (error) {
            // Ocultar loading
            this.hideCalculatingOverlay();

            // Tratar erro
            this.handleCalculationError(error);

            console.error('‚ùå [TabNavigation] Erro no c√°lculo autom√°tico:', error);
        }
    }

    /**
     * Mostra overlay de loading durante c√°lculo
     */
    showCalculatingOverlay() {
        const overlay = document.createElement('div');
        overlay.className = 'calculating-overlay';
        overlay.id = 'calculatingOverlay';
        overlay.innerHTML = `
            <div class="spinner"></div>
            <p>Calculando √≠ndices financeiros...</p>
            <small>Processando dados e valida√ß√µes</small>
        `;

        const activeSection = document.querySelector('.form-section.active');
        if (activeSection) {
            activeSection.style.position = 'relative';
            activeSection.appendChild(overlay);
        }
    }

    /**
     * Oculta overlay de loading
     */
    hideCalculatingOverlay() {
        const overlay = document.getElementById('calculatingOverlay');
        if (overlay) {
            overlay.remove();
        }
    }

    /**
     * Exibe toast notification
     * @param {string} message
     * @param {string} type - 'success', 'error', 'warning', 'info'
     */
    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;

        document.body.appendChild(toast);

        // Auto-remove ap√≥s 3 segundos
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    /**
     * Trata erros de c√°lculo
     * @param {Error} error
     */
    handleCalculationError(error) {
        if (error.name === 'ValidationError') {
            // Erro de valida√ß√£o - mostrar campos faltantes
            const errorList = error.errors.map(err => err.message).join('\n');

            this.showToast(
                `Dados incompletos: ${error.errors.length} campos precisam ser preenchidos`,
                'error'
            );

            console.error('Erros de valida√ß√£o:', errorList);

        } else {
            // Erro gen√©rico
            this.showToast(
                `Erro ao calcular: ${error.message}`,
                'error'
            );
        }
    }
}

// Export class to window (available immediately for dependency checks)
if (typeof window !== 'undefined') {
    window.SimpleTabNavigation = SimpleTabNavigation;
}

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
    module.exports = SimpleTabNavigation;
}

// NOTE: Initialization is managed by CreditScoreProApp.initNavigationAndDB()
// SimpleTabNavigation is created AFTER form generation in analise-credito.html
